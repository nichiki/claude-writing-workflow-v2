# Claude Code コマンド作成ガイドライン

このドキュメントは、Claude Codeがコマンドを作成する際の品質と一貫性を保つためのガイドラインです。
公式ドキュメント: https://docs.anthropic.com/en/docs/claude-code/slash-commands

## 1. コマンド設計の原則

### 1.1 単一責任の原則
- 1つのコマンドは1つの明確な目的を持つ
- 複雑なタスクは複数のコマンドに分割する

### 1.2 コマンド分割の基準
以下のいずれかに該当する場合、コマンドを分割する：
- 異なるコンテキスト（例：リサーチと執筆）を扱う
- 再利用可能な処理単位である
- 独立して実行されることが多い処理
- エラー時の再実行単位として適切

### 1.3 依存関係の管理
- コマンド間の依存は最小限に
- 前提条件は明示的に記述
- 共通処理はutilコマンドとして切り出す

## 2. ファイル構造とフォーマット

### 2.1 基本構造
```markdown
---
description: "30文字以内の簡潔な説明"
allowed-tools: Bash, Read, Write  # 必要な権限を明示
---

# 前提条件
- 必要なファイル/ディレクトリ
- 事前に実行すべきコマンド

# 実行内容
## ステップ1: 説明
具体的な処理内容

## ステップ2: 説明
具体的な処理内容

# 実行後の状態
- 作成されるファイル
- 変更される状態
```

### 2.2 YAMLフロントマター
- `description`: 必須。ユーザーが理解しやすい簡潔な説明
- `allowed-tools`: セキュリティのため、使用するツールを明示的に指定

### 2.3 特殊構文の使用
```markdown
# ファイル参照（内容を含める）
@path/to/file.yaml

# Bashコマンド実行（結果を含める）
!date +"%Y-%m-%d %H:%M:%S"

# 引数の使用
$ARGUMENTS または ${ARGUMENTS:-default_value}
```

## 3. 命名規則

### 3.1 コマンドファイル名
- 小文字英数字とハイフンのみ使用
- 動詞で始める（create, update, check, etc.）
- 15文字以内を目安に

### 3.2 ディレクトリ構造
```
.claude/commands/
├── main_workflow.md      # メインワークフロー（ネームスペースなし）
├── step/                 # 個別ステップ
├── style/                # 特定機能グループ
├── manage/               # 管理系
└── util/                 # ユーティリティ
```

## 4. エラーハンドリング

### 4.1 エラーケースの明示
```markdown
# エラー処理
- ファイルが存在しない場合
  → "エラー: brief.yamlが見つかりません。先に/step:interviewを実行してください"
- 日付取得失敗時
  → デフォルト値 "unknown_date" を使用
```

### 4.2 コマンドファイル読み込み失敗時の対処
**重要**: `@`記法でコマンドファイルを読み込む際、ファイルが見つからない場合は以下の手順で対処する：

1. **パスの再確認**
   - 記載されたパスが正しいか確認（勝手にディレクトリを追加・変更しない）
   - 例: `@.claude/commands/util/select-project.md` を `@.claude/commands/project/util/select-project.md` に変更しない

2. **代替パスの探索**
   ```
   元のパス: @.claude/commands/util/select-project.md
   探索順序:
   1) .claude/commands/util/select-project.md （そのまま）
   2) .claude/commands/select-project.md （一階層上）
   3) 諦めてユーザーに確認
   ```

3. **ユーザーへの確認**
   - ファイルが見つからない場合は、勝手に処理を進めず、必ずユーザーに確認
   - 「○○が見つかりません。代わりに△△を実行してもよろしいですか？」

### 4.3 再実行可能性
- 冪等性を保つ（何度実行しても同じ結果）
- 既存ファイルの上書き前に確認
- 部分的な失敗からの復旧を考慮

## 5. コンテキストとフィードバック

### 5.1 進行状況の表示
```markdown
# ステップ1/3: データ収集
処理内容...

# ステップ2/3: 分析
処理内容...

# 完了: 結果をresult.yamlに保存しました
```

### 5.2 デバッグ情報
```markdown
# 現在の状態確認
!pwd
!ls -la projects/

# 処理対象の確認
対象ファイル: @projects/$ARGUMENTS/brief.yaml
```

## 6. 再利用性とモジュール性

### 6.1 共通処理の切り出し
```markdown
# 悪い例：各コマンドで日付処理を記述
!date +"%Y-%m-%d %H:%M:%S" > timestamp.txt

# 良い例：utilコマンドを呼び出し
/util:dateを実行して現在日時を取得
```

### 6.2 コマンドの組み合わせ
```markdown
# 他のコマンドの参照
以下のコマンドを順次実行：
1. @.claude/commands/step/interview.md
2. @.claude/commands/step/research.md
```

## 7. パフォーマンスとユーザビリティ

### 7.1 実行時間の考慮
- 長時間かかる処理には進行状況を表示
- バッチ処理は明示的に「時間がかかる」旨を記載

### 7.2 ユーザーフレンドリーな出力
```markdown
# 処理開始
🚀 記事の執筆を開始します...

# 進行状況
📝 アウトライン作成中... [1/3]
🔍 リサーチ実行中... [2/3]
✍️  執筆中... [3/3]

# 完了
✅ 完了しました！
📄 結果: projects/2024-01-15_article/draft.md
```

### 7.3 Bashコマンドの出力処理
**重要な原則**: Bashコマンドは情報取得の手段であり、ユーザーへの表示はClaude Code側で行う。

```markdown
# 悪い例：Bashの出力をそのまま表示に使う
!echo "以下から選択してください："
!ls projects/ | nl

# 良い例：Bashで情報取得、Claude Codeで表示
!ls projects/
# 上記で取得したプロジェクト一覧を基に、Claude Codeが以下のように表示：
# 
# 以下から選択してください：
# 1) project-a
# 2) project-b
# 3) project-c
```

コマンドファイルはデータ取得の指示を記述し、実際の表示整形はClaude Codeに任せる。

## 8. テスト可能性

### 8.1 テストケースの想定
```markdown
# テストシナリオ
1. 正常系：全ステップが成功
2. 異常系：ファイルが存在しない
3. 境界値：空の入力、非常に長い入力
```

### 8.2 デバッグモード
```markdown
# デバッグ情報の表示（必要に応じて）
DEBUG: 読み込んだ設定: @config.yaml
DEBUG: 生成されたコマンド: !echo "test"
```

## 9. ドキュメンテーション

### 9.1 使用例の提供
```markdown
# 使用例
/step:interview my-first-article
/step:interview "複数単語の記事名"
```

### 9.2 関連コマンドの明示
```markdown
# 関連コマンド
- 前: /step:interview
- 次: /step:outline
- 関連: /style:apply
```

## 10. セキュリティとプライバシー

### 10.1 権限の最小化
- 必要最小限のツールのみ `allowed-tools` に指定
- ファイルシステムへのアクセスは必要な範囲に限定

### 10.2 機密情報の扱い
- APIキーやパスワードを含めない
- 個人情報を含む可能性のあるファイルは明示的に警告

## チェックリスト

新しいコマンドを作成する際は、以下を確認：

- [ ] 単一の明確な目的を持っているか
- [ ] YAMLフロントマターが適切か
- [ ] エラーケースを考慮しているか
- [ ] 再実行可能か
- [ ] 進行状況が分かりやすいか
- [ ] 他のコマンドとの一貫性があるか
- [ ] Bashコマンドは情報取得のみに使用しているか（表示用echoを使っていないか）
- [ ] テストシナリオを想定しているか
- [ ] 使用例を提供しているか
- [ ] セキュリティを考慮しているか

## 11. スタイルガイドの扱い

### 11.1 source_filesセクションの処理
**重要な原則**: スタイルガイドのsource_filesは参照情報として記録されているが、執筆時には読み込まない。

```markdown
# 良い例：スタイルガイドの分析結果のみを使用
スタイルガイド @styles/[スタイル名].yaml を読み込み
→ style_characteristics, vocabulary, tone_markers等の分析結果を使用

# 悪い例：source_filesのファイルを読み込む
スタイルガイドのsource_filesに記載されたファイルをすべて読み込み
→ 不要なファイル読み込みによる処理遅延
```

スタイルガイドには既に分析結果が集約されているため、元のソースファイルを参照する必要はない。

## 改訂履歴

- 2024-01-15: 初版作成
- 2025-07-01: Bashコマンドの出力処理に関する重要な原則を追加（7.3節）
- 2025-07-01: スタイルガイドのsource_files処理に関するルールを追加（11節）
- 2025-07-01: コマンドファイル読み込み失敗時の対処法を追加（4.2節）